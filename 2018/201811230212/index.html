<!doctype html>



  


<html class="theme-next mist use-motion">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="CSharp,.Net Core,Email,">





  <link rel="alternate" href="/atom.xml" title="Vick's Blog" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/icon.ico?v=5.0.1">






<meta name="description" content="邮件服务是一般的系统都会拥有和需要的功能，但是对于.Net项目来说，邮件服务的创建和使用会较为的麻烦。.NET对于邮件功能提供了System.Net.Mail用于创建邮件服务，该基础服务提供邮件的基础操作，并且使用也较为的简单。对于真正将该功能使用于项目的人，就会慢慢发现其中的优缺点，甚至有些时候不能忍受其中的问题。在这里介绍一种微软用于替代System.Net.Mail的邮件服务组件MailKi">
<meta name="keywords" content="CSharp,.Net Core,Email">
<meta property="og:type" content="article">
<meta property="og:title" content=".Net Core使用mailkit收取和发送邮件">
<meta property="og:url" content="VickChen.win/2018/201811230212/index.html">
<meta property="og:site_name" content="Vick&#39;s Blog">
<meta property="og:description" content="邮件服务是一般的系统都会拥有和需要的功能，但是对于.Net项目来说，邮件服务的创建和使用会较为的麻烦。.NET对于邮件功能提供了System.Net.Mail用于创建邮件服务，该基础服务提供邮件的基础操作，并且使用也较为的简单。对于真正将该功能使用于项目的人，就会慢慢发现其中的优缺点，甚至有些时候不能忍受其中的问题。在这里介绍一种微软用于替代System.Net.Mail的邮件服务组件MailKi">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-07-26T02:57:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content=".Net Core使用mailkit收取和发送邮件">
<meta name="twitter:description" content="邮件服务是一般的系统都会拥有和需要的功能，但是对于.Net项目来说，邮件服务的创建和使用会较为的麻烦。.NET对于邮件功能提供了System.Net.Mail用于创建邮件服务，该基础服务提供邮件的基础操作，并且使用也较为的简单。对于真正将该功能使用于项目的人，就会慢慢发现其中的优缺点，甚至有些时候不能忍受其中的问题。在这里介绍一种微软用于替代System.Net.Mail的邮件服务组件MailKi">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="VickChen.win/2018/201811230212/">

  <title> .Net Core使用mailkit收取和发送邮件 | Vick's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Vick's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                .Net Core使用mailkit收取和发送邮件
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-11-23T02:12:00+08:00" content="2018-11-23">
              2018-11-23
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>邮件服务是一般的系统都会拥有和需要的功能，但是对于.Net项目来说，邮件服务的创建和使用会较为的麻烦。.NET对于邮件功能提供了System.Net.Mail用于创建邮件服务，该基础服务提供邮件的基础操作，并且使用也较为的简单。对于真正将该功能使用于项目的人，就会慢慢发现其中的优缺点，甚至有些时候不能忍受其中的问题。在这里介绍一种微软用于替代System.Net.Mail的邮件服务组件MailKit和MimeKit，官网地址：<a href="http://www.mimekit.net/" target="_blank" rel="noopener">http://www.mimekit.net/</a> GitHub地址：<a href="https://github.com/jstedfast/MimeKit" target="_blank" rel="noopener">https://github.com/jstedfast/MimeKit</a></p>
<a id="more"></a>
<h2 id="MailKit和MimeKit基础概述"><a href="#MailKit和MimeKit基础概述" class="headerlink" title="MailKit和MimeKit基础概述"></a>MailKit和MimeKit基础概述</h2><p>MailKit组件是一个免费开源的邮箱类库，简单来说MailKit帮我们封装了有关邮箱的一些帮助类，提供方法让我们更容易使用邮箱的SMTP、POP3、IMAP等协议。该组件是一个跨平台的Email组件，该组件支持.Net Core 、.Net FrameWork、Xamarin.Android、Xamarin.iOS、Windows Phone等等平台。</p>
<p>MimeKit提供了一个MIME解析器，组件具备的解析特性灵活、性能高、很好的处理各种各样的破碎的MIME格式化。MimeKit的性能实际上与GMime相当。</p>
<p>该组件在安全性的还是比较高的，处理安全的方式较多，SASL认证、支持S / MIME v3.2、支持OpenPGP、支持DKIM签名等等方式。Mailkit组件可以通过CancellationToken取消对应的操作，CancellationToken传播应取消操作的通知，一个的CancellationToken使线程，线程池工作项目之间，或取消合作任务的对象。过实例化CancellationTokenSource对象来创建取消令牌，该对象管理从其CancellationTokenSource.Token属性检索的取消令牌。然后，将取消令牌传递到应该收到取消通知的任意数量的线程，任务或操作。令牌不能用于启动取消。<br> MailKit组件支持异步操作，在内部编写的有关I/O异步操作的类</p>
<h2 id="创建基础邮件服务"><a href="#创建基础邮件服务" class="headerlink" title="创建基础邮件服务"></a>创建基础邮件服务</h2><p>介绍过MailKit和MimeKit组建的基础信息，接下来就介绍一下如何使用两个组件的基本功能，在这里我将基本操作做了一个简单的封装，一般的项目可以直接引用封装好的类，大家可以根据实际的情况对该组件进行扩展。</p>
<h3 id="基础实体类"><a href="#基础实体类" class="headerlink" title="基础实体类"></a>基础实体类</h3><h4 id="邮件实体类"><a href="#邮件实体类" class="headerlink" title="邮件实体类"></a>邮件实体类</h4><p>用于保存邮件至数据库</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MailBoxEntity</span> : <span class="title">BaseEntity</span> &#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 该邮件所属邮箱账号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> OwnerMailAccount &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 邮件主题</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Subject &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 邮件文本内容</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> MailTextBody &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 邮件html内容</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> MailHtmlBody &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 邮件内容类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> MailBodyType &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">"html"</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 邮件附件文件路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> MailFilePath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 收件人地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Recipients &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 收件人名字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> RecipientsName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 抄送</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Cc &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 密送</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Bcc &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 发件人</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Sender &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 发件人地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> SenderAddress &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 邮件类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> MailType &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 收件/发件时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Date &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 邮件标识</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否已读，是否回复，是否删除</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> Flag &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否已读</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsRead &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否已经回复</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsAnswered &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 邮件唯一标识</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> MessageId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 邮件唯一查询标识</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">uint</span>? UniqueId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 引用邮件唯一标识</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> References &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 邮件所属邮箱服务器的文件夹标识</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> inbox(收件箱),</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> archive(档案箱),</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> drafts(草稿箱),</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> flagged(标记的),</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> junk(垃圾箱),</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> sent(发件箱),</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> trash(回收箱)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> FolderType &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 文件夹名称</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 一般用于区别Inbox文件夹下用户自定义的文件夹</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> FolderName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 附件个数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>? AttaCount &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">NotMapped</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;MailBoxEntity&gt; MailBoxList &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="邮箱发送服务器配置"><a href="#邮箱发送服务器配置" class="headerlink" title="邮箱发送服务器配置"></a>邮箱发送服务器配置</h4><p>此表用于保存邮箱的账号信息及不同邮箱服务器的SMTP端口等信息</p>
<p>当然，这些信息可以拆分成两个表存储。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MailConfigEntity</span> : <span class="title">BaseEntity</span> &#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 邮箱显示名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> DisplayName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 发件SMTP服务器地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> SmtpHost &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 收件Imtp服务器地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> ImapHost &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 发件SMTP服务器端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>? SmtpPort &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 收件Imtp服务器端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>? ImapPort &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否启用SSL</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsSsl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 邮件编码</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> MailEncoding &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">"UTF-8"</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 邮箱账号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Account &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 邮箱密码/授权码</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 平台ID</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> PlatId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新到的日期</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> UpdateTo &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 总发件数量</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> SentCount &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="number">0</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 员工自定义的文件夹列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">NotMapped</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;MailFolderEntity&gt; MailFolders &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="邮件发送结果信息"><a href="#邮件发送结果信息" class="headerlink" title="邮件发送结果信息"></a>邮件发送结果信息</h4><p>用于保存每一封邮件的发送状态，后续也可以关联其它业务表，与自动发送邮件任务配合，记录更多相关信息</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SendResultEntity</span> : <span class="title">BaseEntity</span> &#123;</span><br><span class="line">    <span class="comment">// [MaxLength (50)]</span></span><br><span class="line">    <span class="comment">// public string OrderId &#123; get; set; &#125;</span></span><br><span class="line">    <span class="comment">// [MaxLength (50)]</span></span><br><span class="line">    <span class="comment">// public string ReviewId &#123; get; set; &#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> MailId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 结果信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> ResultInformation &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">"发送成功！"</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 结果状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> ResultStatus &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="邮件操作服务"><a href="#邮件操作服务" class="headerlink" title="邮件操作服务"></a>邮件操作服务</h3><h4 id="配置基础信息"><a href="#配置基础信息" class="headerlink" title="配置基础信息"></a>配置基础信息</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 账户认证</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Authenticate</span> (<span class="params">MailConfigEntity mailConfigEntity, SmtpClient client, SendResultEntity sendResultEntity</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        client.Authenticate (mailConfigEntity.Account, mailConfigEntity.Password);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AuthenticationException ex) &#123;</span><br><span class="line">        sendResultEntity.ResultInformation = <span class="string">$"无效的用户名或密码:<span class="subst">&#123;<span class="number">0</span>&#125;</span>"</span> + ex.Message;</span><br><span class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SmtpCommandException ex) &#123;</span><br><span class="line">        sendResultEntity.ResultInformation = <span class="string">$"尝试验证错误:<span class="subst">&#123;<span class="number">0</span>&#125;</span>"</span> + ex.Message;</span><br><span class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SmtpProtocolException ex) &#123;</span><br><span class="line">        sendResultEntity.ResultInformation = <span class="string">$"尝试验证时的协议错误:<span class="subst">&#123;<span class="number">0</span>&#125;</span>"</span> + ex.Message;</span><br><span class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        sendResultEntity.ResultInformation = <span class="string">$"账户认证错误:<span class="subst">&#123;<span class="number">0</span>&#125;</span>"</span> + ex.Message;</span><br><span class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取SMTP基础信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> MailServerInformationEntity <span class="title">SmtpClientBaseMessage</span> (<span class="params">SmtpClient client</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> mailServerInformation = <span class="keyword">new</span> MailServerInformationEntity &#123;</span><br><span class="line">        Authentication = client.Capabilities.HasFlag (SmtpCapabilities.Authentication),</span><br><span class="line">        BinaryMime = client.Capabilities.HasFlag (SmtpCapabilities.BinaryMime),</span><br><span class="line">        Dsn = client.Capabilities.HasFlag (SmtpCapabilities.Dsn),</span><br><span class="line">        EightBitMime = client.Capabilities.HasFlag (SmtpCapabilities.EightBitMime),</span><br><span class="line">        Size = client.MaxSize</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> mailServerInformation;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 连接服务器</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Connection</span> (<span class="params">MailConfigEntity sendServerConfiguration, SmtpClient client, SendResultEntity sendResultEntity</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        client.Connect (sendServerConfiguration.SmtpHost, sendServerConfiguration.SmtpPort.Value);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SmtpCommandException ex) &#123;</span><br><span class="line">        sendResultEntity.ResultInformation = <span class="string">$"尝试连接时出错:<span class="subst">&#123;<span class="number">0</span>&#125;</span>"</span> + ex.Message;</span><br><span class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SmtpProtocolException ex) &#123;</span><br><span class="line">        sendResultEntity.ResultInformation = <span class="string">$"尝试连接时的协议错误:<span class="subst">&#123;<span class="number">0</span>&#125;</span>"</span> + ex.Message;</span><br><span class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        sendResultEntity.ResultInformation = <span class="string">$"服务器连接错误:<span class="subst">&#123;<span class="number">0</span>&#125;</span>"</span> + ex.Message;</span><br><span class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"> <span class="comment"><span class="doctag">///</span> 设置发件人信息</span></span><br><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> SmtpClient <span class="title">SmtpClientInit</span> (<span class="params"><span class="keyword">int</span> accountId</span>)</span> &#123;</span><br><span class="line">     <span class="keyword">var</span> m = _mailConfigService.GetAsNoTracking ();</span><br><span class="line">     MailConfigEntity mailConfig = m.FirstOrDefault (a =&gt; a.FID == accountId);</span><br><span class="line">     SmtpClient client = <span class="keyword">new</span> SmtpClient () &#123;</span><br><span class="line">         ServerCertificateValidationCallback = (s, c, h, e) =&gt; <span class="literal">true</span></span><br><span class="line">     &#125;;</span><br><span class="line">     <span class="keyword">var</span> sendResultEntity = <span class="keyword">new</span> SendResultEntity ();</span><br><span class="line">     Connection (mailConfig, client, sendResultEntity);</span><br><span class="line">     <span class="keyword">if</span> (sendResultEntity.ResultStatus == <span class="literal">false</span>)</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">     SmtpClientBaseMessage (client);</span><br><span class="line">     Authenticate (mailConfig, client, sendResultEntity);</span><br><span class="line">     <span class="keyword">return</span> sendResultEntity.ResultStatus == <span class="literal">false</span> ? <span class="literal">null</span> : client;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"> <span class="comment"><span class="doctag">///</span> 设置收件人信息</span></span><br><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ImapClient <span class="title">ImapClientInit</span> (<span class="params"><span class="keyword">int</span> AccountId</span>)</span> &#123;</span><br><span class="line">    MailConfigEntity mailConfig = _mailConfigService.GetAsNoTracking ().FirstOrDefault (a =&gt; a.FID == AccountId);</span><br><span class="line">    ImapClient client = <span class="keyword">new</span> ImapClient ();</span><br><span class="line">    client.Connect (mailConfig.ImapHost, mailConfig.ImapPort.Value,</span><br><span class="line">        SecureSocketOptions.SslOnConnect);</span><br><span class="line">    client.Authenticate (mailConfig.Account, mailConfig.Password);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 网易邮箱需要此语句，用于验证客户端身份</span></span><br><span class="line">    <span class="keyword">if</span> (mailConfig.ImapHost == <span class="string">"imap.126.com"</span> || mailConfig.ImapHost == <span class="string">"imap.163.com"</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> clientImplementation = <span class="keyword">new</span> ImapImplementation &#123;</span><br><span class="line">        Name = <span class="string">"MeSince"</span>,</span><br><span class="line">        Version = <span class="string">"2.0"</span></span><br><span class="line">        &#125;;</span><br><span class="line">        client.Identify (clientImplementation);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">    <span class="keyword">return</span> client;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="发送邮件"><a href="#发送邮件" class="headerlink" title="发送邮件"></a>发送邮件</h4><p><em>Mailkit使用时会遇到“附件文件名不能为中文”和“附件文件名长度不能超过41字符”的Bug，这里我顺便参照网上的解决了</em></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 组装邮件文本/附件邮件信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MimeMessage <span class="title">AssemblyMailMessage</span> (<span class="params">MailBoxEntity mailBoxEntity</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mailBoxEntity == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException (<span class="keyword">nameof</span> (mailBoxEntity));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> message = <span class="keyword">new</span> MimeMessage ();</span><br><span class="line">    <span class="comment">//设置邮件基本信息</span></span><br><span class="line">    SetMailBaseMessage (message, mailBoxEntity);</span><br><span class="line">    <span class="keyword">var</span> multipart = <span class="keyword">new</span> Multipart (<span class="string">"mixed"</span>);</span><br><span class="line">    <span class="comment">//插入文本消息</span></span><br><span class="line">    <span class="keyword">if</span> (mailBoxEntity.MailHtmlBody.IsNotNullAndWhiteSpace ()) &#123;</span><br><span class="line">        multipart.Add (<span class="keyword">new</span> MultipartAlternative &#123;</span><br><span class="line">            AssemblyMailTextMessage (mailBoxEntity.MailHtmlBody, mailBoxEntity.MailBodyType)</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//插入附件信息</span></span><br><span class="line">    <span class="keyword">if</span> (mailBoxEntity.MailFilePath.IsNotNullAndWhiteSpace ()) &#123;</span><br><span class="line">        List&lt;FileStream&gt; list = <span class="keyword">new</span> List&lt;FileStream&gt; ();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> path <span class="keyword">in</span> mailBoxEntity.MailFilePath.Split (<span class="string">'|'</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!File.Exists (path))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException (<span class="string">"文件未找到"</span>, path);</span><br><span class="line">            <span class="keyword">string</span>[] contentTypeArr = MimeTypes.GetMimeType (path).Split (<span class="string">'/'</span>);</span><br><span class="line">            FileStream file = File.Open (path, FileMode.Open);</span><br><span class="line">            list.Add (file);</span><br><span class="line">            ContentType contentType = <span class="keyword">new</span> ContentType (contentTypeArr[<span class="number">0</span>], contentTypeArr[<span class="number">1</span>]);</span><br><span class="line">            MimePart mimePart = <span class="keyword">new</span> MimePart (contentType) &#123;</span><br><span class="line">                Content = <span class="keyword">new</span> MimeContent (file),</span><br><span class="line">                ContentDisposition = <span class="keyword">new</span> ContentDisposition (ContentDisposition.Attachment),</span><br><span class="line">                ContentTransferEncoding = ContentEncoding.Base64,</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">//解决文件名不能为中文</span></span><br><span class="line">            mimePart.ContentType.Parameters.Add (<span class="string">"GB18030"</span>, <span class="string">"name"</span>, Path.GetFileName (path));</span><br><span class="line">            mimePart.ContentDisposition.Parameters.Add (<span class="string">"GB18030"</span>, <span class="string">"filename"</span>, Path.GetFileName (path));</span><br><span class="line">            <span class="comment">//解决文件名长度限制</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> param <span class="keyword">in</span> mimePart.ContentDisposition.Parameters)</span><br><span class="line">                param.EncodingMethod = ParameterEncodingMethod.Rfc2047;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> param <span class="keyword">in</span> mimePart.ContentType.Parameters)</span><br><span class="line">                param.EncodingMethod = ParameterEncodingMethod.Rfc2047;</span><br><span class="line">            multipart.Add (mimePart);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//组合邮件内容</span></span><br><span class="line">    message.Body = multipart;</span><br><span class="line">    <span class="keyword">return</span> message;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 设置邮件基础信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MimeMessage <span class="title">SetMailBaseMessage</span> (<span class="params">MimeMessage minMessag, MailBoxEntity mailBoxEntity</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (minMessag == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException ();</span><br><span class="line">    <span class="keyword">if</span> (mailBoxEntity == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException ();</span><br><span class="line">    <span class="comment">//插入发件人</span></span><br><span class="line">    minMessag.From.Add (<span class="keyword">new</span> MailboxAddress (mailBoxEntity.Sender, mailBoxEntity.SenderAddress));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入收件人</span></span><br><span class="line">    <span class="keyword">string</span>[] _recipients = mailBoxEntity.Recipients.Split (<span class="string">"|"</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> recipients <span class="keyword">in</span> _recipients) &#123;</span><br><span class="line">        minMessag.To.Add (<span class="keyword">new</span> MailboxAddress (recipients.Trim ()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mailBoxEntity.Cc.IsNotNullAndWhiteSpace ()) &#123;</span><br><span class="line">        <span class="comment">//插入抄送人</span></span><br><span class="line">        <span class="keyword">string</span>[] _cc = mailBoxEntity.Cc.Split (<span class="string">"|"</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> cc <span class="keyword">in</span> _cc)</span><br><span class="line">            minMessag.Cc.Add (<span class="keyword">new</span> MailboxAddress (cc));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mailBoxEntity.Bcc.IsNotNullAndWhiteSpace ()) &#123;</span><br><span class="line">        <span class="comment">//插入密送人</span></span><br><span class="line">        <span class="keyword">string</span>[] _bcc = mailBoxEntity.Bcc.Split (<span class="string">"|"</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> bcc <span class="keyword">in</span> _bcc)</span><br><span class="line">            minMessag.Bcc.Add (<span class="keyword">new</span> MailboxAddress (bcc));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//插入主题</span></span><br><span class="line">    minMessag.Subject = mailBoxEntity.Subject;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> minMessag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 组装邮件文本信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> TextPart <span class="title">AssemblyMailTextMessage</span> (<span class="params"><span class="keyword">string</span> mailBody, <span class="keyword">string</span> textPartType</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty (mailBody))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException ();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty (textPartType))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException ();</span><br><span class="line">    <span class="keyword">var</span> textBody = <span class="keyword">new</span> TextPart (textPartType) &#123;</span><br><span class="line">        Text = mailBody</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> textBody;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 发送邮件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Send</span> (<span class="params">MailBoxEntity mailBoxEntity, SmtpClient client, SendResultEntity sendResultEntity, <span class="keyword">string</span> replyto, <span class="keyword">int</span> accid</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        MimeMessage mimeMessage = _mailMessageService.AssemblyMailMessage (mailBoxEntity);</span><br><span class="line">        <span class="keyword">if</span> (replyto.IsNotNullAndWhiteSpace ()) &#123;</span><br><span class="line">            <span class="keyword">uint</span>.TryParse (replyto.Trim (<span class="string">'|'</span>), <span class="keyword">out</span> <span class="keyword">uint</span> mailuint);</span><br><span class="line">            SetReplyTo (mailuint, mimeMessage, accid); <span class="comment">//设置回复</span></span><br><span class="line">        &#125;</span><br><span class="line">        client.Send (mimeMessage);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mimeMessage.References != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> mimeMessage.References)</span><br><span class="line">                mailBoxEntity.References = mailBoxEntity.References + <span class="string">"|"</span> + item;</span><br><span class="line">        &#125;</span><br><span class="line">        mailBoxEntity.References = mailBoxEntity.References?.Trim (<span class="string">'|'</span>);</span><br><span class="line">        mailBoxEntity.MessageId = mimeMessage.MessageId;</span><br><span class="line"></span><br><span class="line">        sendResultEntity.MailId = mailBoxEntity.MailType == (<span class="keyword">int</span>) MailType.Auto </span><br><span class="line">        ? _mailBoxService.Add (mailBoxEntity, <span class="literal">true</span>, <span class="literal">true</span>) : _mailBoxService.Add (mailBoxEntity, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (SmtpCommandException ex) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (ex.ErrorCode) &#123;</span><br><span class="line">            <span class="keyword">case</span> SmtpErrorCode.RecipientNotAccepted:</span><br><span class="line">                sendResultEntity.ResultInformation = <span class="string">$"收件人未被接受:<span class="subst">&#123;ex.Message&#125;</span>"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SmtpErrorCode.SenderNotAccepted:</span><br><span class="line">                sendResultEntity.ResultInformation = <span class="string">$"发件人未被接受:<span class="subst">&#123;ex.Message&#125;</span>"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SmtpErrorCode.MessageNotAccepted:</span><br><span class="line">                sendResultEntity.ResultInformation = <span class="string">$"消息未被接受:<span class="subst">&#123;ex.Message&#125;</span>"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SmtpProtocolException ex) &#123;</span><br><span class="line">        sendResultEntity.ResultInformation = <span class="string">$"发送消息时的协议错误:<span class="subst">&#123;ex.Message&#125;</span>"</span>;</span><br><span class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        sendResultEntity.ResultInformation = <span class="string">$"邮件发送失败:<span class="subst">&#123;ex.Message&#125;</span>"</span>;</span><br><span class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="收取邮件"><a href="#收取邮件" class="headerlink" title="收取邮件"></a>收取邮件</h4><p>这部分比较繁琐，先贴代码，然后再解释</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 接收所有文件夹的邮件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span> </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">GetFolders</span> (<span class="params"><span class="keyword">string</span> Account</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">bool</span> result = <span class="literal">false</span>;</span><br><span class="line">        MailConfigEntity mailConfig = _mailConfigService.Get ().FirstOrDefault (a =&gt; a.Account == Account);</span><br><span class="line"></span><br><span class="line">        List&lt;DateTime&gt; dateTimes = <span class="keyword">new</span> List&lt;DateTime&gt; &#123;</span><br><span class="line">            Convert.ToDateTime (mailConfig.UpdateTo)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 用户所拥有的文件夹</span></span><br><span class="line">        <span class="keyword">var</span> mailFolderUserEntitys = _mailFolderUserService.GetAsNoTracking ().</span><br><span class="line">        Where (a =&gt; a.AccountUserID == _applicationContext.CurrentUser.FID &amp;&amp; a.DataStatus == (<span class="keyword">int</span>) DataStatus.Active)</span><br><span class="line">            .Select (a =&gt; a.MailFolderId).ToArray ();</span><br><span class="line">        <span class="comment">// 文件夹详细信息</span></span><br><span class="line">        <span class="keyword">var</span> mailFolders = _mailFolderService.GetAsNoTracking ().Where (a =&gt; a.MailAccountId == mailConfig.FID &amp;&amp;</span><br><span class="line">            a.DataStatus == (<span class="keyword">int</span>) DataStatus.Active &amp;&amp; a.FolderType == <span class="number">1</span> &amp;&amp; mailFolderUserEntitys.Contains (a.FID));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> mailFoldersArr = mailFolders.Where (a =&gt; mailFolders.Any (r =&gt; r.ParentFolderId == a.FID) == <span class="literal">false</span>).Select (a =&gt; a.FID).ToArray ();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 文件夹规则表</span></span><br><span class="line">        <span class="keyword">var</span> mailFolderRuleEntities = _mailFolderRuleService.GetAsNoTracking ().Where (a =&gt; mailFoldersArr.Contains (a.FolderId) &amp;&amp;</span><br><span class="line">            a.DataStatus == (<span class="keyword">int</span>) DataStatus.Active &amp;&amp; a.RuleContent.IsNotNullAndWhiteSpace ()).ToList ();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> client = ImapClientInit (mailConfig.FID)) &#123;</span><br><span class="line">            List&lt;IMailFolder&gt; mailFolderList = client.GetFolders (client.PersonalNamespaces[<span class="number">0</span>]).ToList ();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> mailFolderList) &#123;</span><br><span class="line">                item.Open (FolderAccess.ReadOnly);</span><br><span class="line">                <span class="comment">//todo 因未知原因,拉取Junk文件夹邮件拉取时会报错，先跳过</span></span><br><span class="line">                <span class="keyword">if</span> (item.Count &lt; <span class="number">1</span> || item.Name.ToLower () == <span class="string">"junk"</span>) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">var</span> m = FillEntity (<span class="literal">null</span>, <span class="literal">null</span>, item, client, <span class="literal">true</span>, mailConfig.FID);</span><br><span class="line">                <span class="keyword">if</span> (m.MailBoxList.Count &lt; <span class="number">1</span>) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">if</span> (item.Name.ToLower () == <span class="string">"inbox"</span>) &#123;</span><br><span class="line">                    result = <span class="literal">true</span>;</span><br><span class="line">                    <span class="comment">// 邮件归档</span></span><br><span class="line">                    <span class="keyword">if</span> (mailFolderRuleEntities.Any ())</span><br><span class="line">                        MailArchive (m.MailBoxList, mailFolderRuleEntities);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//取出邮件后对比 获得当前文件夹最后一封邮件的时间</span></span><br><span class="line">                <span class="keyword">string</span> maxdate = m.MailBoxList.Max (a =&gt; a.Date);</span><br><span class="line">                DateTime.TryParse (mailConfig.UpdateTo, <span class="keyword">out</span> <span class="keyword">var</span> updateTo);</span><br><span class="line">                DateTime.TryParse (maxdate, <span class="keyword">out</span> <span class="keyword">var</span> date);</span><br><span class="line">                <span class="keyword">if</span> (date &gt; updateTo) dateTimes.Add (Convert.ToDateTime (maxdate));</span><br><span class="line">                <span class="comment">//保存所有邮件 </span></span><br><span class="line">                _mailBoxService.AddRange (m.MailBoxList);</span><br><span class="line">            &#125;</span><br><span class="line">            client.Disconnect (<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// 最后更新时间取所有文件夹最大时间 避免覆盖或取值错误</span></span><br><span class="line">            mailConfig.UpdateTo = dateTimes.Max ().ToString (<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">            <span class="comment">//todo 此处排除字段修改无效</span></span><br><span class="line">            _mailConfigService.Update (mailConfig, <span class="literal">false</span>, <span class="string">"SentCount"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 填充实体   </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 返回新邮件数量</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> MailBoxEntity <span class="title">FillEntity</span> (<span class="params">IMessageSummary emhead = <span class="literal">null</span>, MimeMessage embody = <span class="literal">null</span>, IMailFolder folder = <span class="literal">null</span>, ImapClient client = <span class="literal">null</span>, <span class="keyword">bool</span> Loop = <span class="literal">false</span>, <span class="keyword">int</span> AccountId = <span class="number">0</span></span>)</span> &#123;</span><br><span class="line">         MailBoxEntity mailbox = <span class="keyword">new</span> MailBoxEntity ();</span><br><span class="line">         <span class="keyword">if</span> (emhead != <span class="literal">null</span>) &#123;</span><br><span class="line">             <span class="keyword">if</span> (emhead.Envelope.From.Count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                 mailbox.Sender = emhead.Envelope.From.Mailboxes.ElementAt (<span class="number">0</span>).Name;</span><br><span class="line">                 mailbox.SenderAddress = emhead.Envelope.From.Mailboxes.ElementAt (<span class="number">0</span>).Address;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">//记录邮件唯一标识 后续获取邮件全文后可直接修改</span></span><br><span class="line">             mailbox.MessageId = emhead.Envelope.MessageId;</span><br><span class="line">             <span class="comment">//记录邮件唯一查询标识 后续根据此字段及文件夹联合查询邮件全文</span></span><br><span class="line">             mailbox.UniqueId = emhead.UniqueId.Id;</span><br><span class="line">             <span class="comment">//直接取本地时间 忽略时间差</span></span><br><span class="line">             mailbox.Date = emhead.Date.LocalDateTime.ToString (<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">             <span class="comment">//邮件时间=本地时间+时区差</span></span><br><span class="line">             <span class="comment">//mailbox.Date = emhead.Date.LocalDateTime.</span></span><br><span class="line">             <span class="comment">//    AddHours(emhead.Date.Offset.TotalHours).ToString("yyyy-MM-dd HH:mm:ss");               </span></span><br><span class="line">             mailbox.Subject = emhead.Envelope.Subject;</span><br><span class="line">             <span class="comment">// 有文件夹的则记录邮件头所属文件夹</span></span><br><span class="line">             <span class="keyword">if</span> (folder != <span class="literal">null</span>) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (folder.Attributes.ToString ().Contains (<span class="string">"Inbox"</span>))</span><br><span class="line">                     mailbox.FolderType = <span class="string">"Inbox"</span>;</span><br><span class="line">                 <span class="keyword">else</span> <span class="keyword">if</span> (folder.Attributes.ToString ().Contains (<span class="string">"Sent"</span>))</span><br><span class="line">                     mailbox.FolderType = <span class="string">"Sent"</span>;</span><br><span class="line">                 <span class="keyword">else</span> <span class="keyword">if</span> (folder.Attributes.ToString ().Contains (<span class="string">"Trash"</span>))</span><br><span class="line">                     mailbox.FolderType = <span class="string">"Trash"</span>;</span><br><span class="line">                 <span class="keyword">else</span> <span class="keyword">if</span> (folder.Attributes.ToString ().Contains (<span class="string">"Drafts"</span>))</span><br><span class="line">                     mailbox.FolderType = <span class="string">"Drafts"</span>;</span><br><span class="line">                 <span class="keyword">else</span></span><br><span class="line">                     mailbox.FolderType = <span class="string">"Inbox"</span>;</span><br><span class="line">                 mailbox.FolderName = folder.FullName;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">// 循环记录收件人</span></span><br><span class="line">             <span class="keyword">foreach</span> (<span class="keyword">var</span> _Recipients <span class="keyword">in</span> emhead.Envelope.To.Mailboxes)</span><br><span class="line">                 mailbox.Recipients = mailbox.Recipients + <span class="string">"|"</span> + _Recipients.Address.Trim ();</span><br><span class="line">             mailbox.Recipients = mailbox.Recipients?.Trim (<span class="string">'|'</span>);</span><br><span class="line">             <span class="comment">//标记为收到的邮件</span></span><br><span class="line">             mailbox.MailType = (<span class="keyword">int</span>) MailType.In;</span><br><span class="line">             <span class="comment">// 邮件状态,已读未读等等</span></span><br><span class="line">             <span class="keyword">if</span> (emhead.Flags.HasValue &amp;&amp; mailbox.FolderType == <span class="string">"Inbox"</span>) &#123;</span><br><span class="line">                 mailbox.IsRead = emhead.Flags.Value.HasFlag (MessageFlags.Seen);</span><br><span class="line">                 mailbox.IsAnswered = emhead.Flags.Value.HasFlag (MessageFlags.Answered);</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">// 附件个数</span></span><br><span class="line">             mailbox.AttaCount = emhead.Attachments.Count ();</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (embody != <span class="literal">null</span>) &#123;</span><br><span class="line">             mailbox.OwnerMailAccount = AccountId;</span><br><span class="line">             <span class="comment">// 正文</span></span><br><span class="line">             mailbox.MailTextBody = embody.TextBody;</span><br><span class="line">             mailbox.MailHtmlBody = embody.HtmlBody;</span><br><span class="line">             <span class="keyword">foreach</span> (<span class="keyword">var</span> _Cc <span class="keyword">in</span> embody.Cc) <span class="comment">//抄送</span></span><br><span class="line">                 mailbox.Cc = embody.Cc + <span class="string">"|"</span> + ((MailboxAddress) _Cc).Address.Trim ();</span><br><span class="line">             mailbox.Cc = mailbox.Cc?.Trim (<span class="string">'|'</span>);</span><br><span class="line">             <span class="keyword">foreach</span> (<span class="keyword">var</span> _Bcc <span class="keyword">in</span> embody.Bcc) <span class="comment">//密送</span></span><br><span class="line">                 mailbox.Bcc = embody.Bcc + <span class="string">"|"</span> + ((MailboxAddress) _Bcc).Address.Trim ();</span><br><span class="line">             mailbox.Bcc = mailbox.Bcc?.Trim (<span class="string">'|'</span>);</span><br><span class="line">             <span class="keyword">foreach</span> (<span class="keyword">var</span> _References <span class="keyword">in</span> embody.References) <span class="comment">//引用</span></span><br><span class="line">                 mailbox.References = embody.References + <span class="string">"|"</span> + _References;</span><br><span class="line">             mailbox.References = mailbox.References?.Trim (<span class="string">'|'</span>);</span><br><span class="line">             <span class="keyword">if</span> (embody.Attachments.Count () &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                 <span class="comment">// 收件箱箱附件保存路径</span></span><br><span class="line">                 <span class="keyword">string</span> _guid = !<span class="keyword">string</span>.IsNullOrEmpty (embody.MessageId) ? embody.MessageId : Guid.NewGuid ().ToString ();</span><br><span class="line">                 <span class="keyword">string</span> _rootPath = Directory.GetDirectoryRoot (Directory.GetCurrentDirectory ()) + <span class="string">@"RecMailAttachment\"</span> + <span class="string">$" <span class="subst">&#123; _guid &#125;</span></span></span><br><span class="line"><span class="string">                 "</span>;</span><br><span class="line">            <span class="keyword">if</span> (!Directory.Exists(_rootPath))</span><br><span class="line">                Directory.CreateDirectory(_rootPath);</span><br><span class="line">            FileInfo fileInfo;</span><br><span class="line">            <span class="comment">//附件路径集合</span></span><br><span class="line">            List&lt;<span class="keyword">string</span>&gt; _attachPaths = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">            <span class="comment">// 这里要转成mimepart类型</span></span><br><span class="line">            <span class="keyword">foreach</span> (MimePart attachment <span class="keyword">in</span> embody.Attachments)</span><br><span class="line">            &#123;</span><br><span class="line">                fileInfo = <span class="keyword">new</span> FileInfo(Path.Combine(_rootPath, attachment.FileName));</span><br><span class="line">                _attachPaths.Add(fileInfo.ToString());</span><br><span class="line">                <span class="keyword">if</span> (File.Exists(fileInfo.ToString())) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">using</span> (FileStream fs = <span class="keyword">new</span> FileStream(fileInfo.ToString(), FileMode.Create))</span><br><span class="line">                &#123;</span><br><span class="line">                    attachment.Content.DecodeTo(fs);</span><br><span class="line">                    fs.Flush();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            mailbox.MailFilePath = _attachPaths.Aggregate((ttl, next) =&gt; <span class="keyword">string</span>.Format(<span class="string">$" <span class="subst">&#123; ttl &#125;</span> | <span class="subst">&#123; next &#125;</span>"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//不需要循环或者未指定文件夹的直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (folder == <span class="literal">null</span> || !Loop)</span><br><span class="line">        <span class="keyword">return</span> mailbox;</span><br><span class="line">    <span class="comment">//需要循环的则循环整个文件夹取值</span></span><br><span class="line">    MailConfigEntity mailConfig = _mailConfigService.Get ().FirstOrDefault (a =&gt; a.FID == AccountId);</span><br><span class="line">    <span class="keyword">var</span> mails = _mailBoxService.GetAsNoTracking ().Where (a =&gt; a.OwnerMailAccount == mailConfig.FID &amp;&amp; a.MailType == <span class="number">1</span>).Select (a =&gt; a.UniqueId);</span><br><span class="line">    mailbox.MailBoxList = <span class="keyword">new</span> List&lt;MailBoxEntity&gt; ();</span><br><span class="line">    IList&lt;UniqueId&gt; uids;</span><br><span class="line">    <span class="comment">//如果之前更新过 则仅同步上次同步之后的邮件</span></span><br><span class="line">    DateTime Updateto = DateTime.MinValue;</span><br><span class="line">    <span class="keyword">if</span> (mailConfig.UpdateTo.IsNotNullAndWhiteSpace ())</span><br><span class="line">    &#123;</span><br><span class="line">        DateTime.TryParse (mailConfig.UpdateTo, <span class="keyword">out</span> Updateto);</span><br><span class="line">        uids = client.GetFolder (folder.FullName).Search (SearchQuery.DeliveredAfter (Updateto));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span><span class="comment">//若是第一次更新 则取出所有邮件</span></span><br><span class="line">        uids = client.GetFolder (folder.FullName).Search (SearchQuery.All);</span><br><span class="line">    <span class="keyword">if</span> (uids.Count &lt; <span class="number">1</span>) <span class="keyword">return</span> mailbox;</span><br><span class="line">    <span class="keyword">int</span> pagecount;</span><br><span class="line">    <span class="keyword">int</span> sum = uids.Count &gt; <span class="number">1000</span> ? <span class="number">1000</span> : uids.Count;</span><br><span class="line">    <span class="keyword">int</span> pageSize = <span class="number">100</span>; <span class="comment">// 每页记录数</span></span><br><span class="line">    <span class="keyword">if</span> (sum % pageSize == <span class="number">0</span>)</span><br><span class="line">        pagecount =sum / pageSize;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        pagecount = sum / pageSize + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= pagecount; i++)<span class="comment">//分页取最后一千封邮件</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> cpage = uids.SkipLast ((i - <span class="number">1</span>) * pageSize).TakeLast (pageSize).ToList ();</span><br><span class="line">        <span class="keyword">var</span> items = folder.Fetch (cpage, MessageSummaryItems.UniqueId | MessageSummaryItems.All);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> items)</span><br><span class="line">        &#123;</span><br><span class="line">            DateTime.TryParse (item.Date.LocalDateTime.ToString (), <span class="keyword">out</span> DateTime date);</span><br><span class="line">            <span class="keyword">if</span> (date &lt; Updateto || mails.Any (a =&gt; a == item.UniqueId.Id))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">//取出正文</span></span><br><span class="line">            MimeMessage ebody = folder.GetMessage (item.UniqueId);</span><br><span class="line">            <span class="keyword">var</span> mbox = FillEntity (item, ebody, folder, <span class="literal">null</span>, <span class="literal">false</span>, AccountId);</span><br><span class="line">            mailbox.MailBoxList.Add (mbox);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mailbox;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>原本逻辑为初次仅拉取邮件头，用户点击详情后再拉取详情。收件速度可成倍提升</p>
<p>但目前客户需求在列表预览邮件部分内容，所以暂时选择全部拉取，后续可以改为仅拉取加载出邮件头的详情</p>
<h4 id="其他操作"><a href="#其他操作" class="headerlink" title="其他操作"></a>其他操作</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 设置单个邮件状态</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> MimeMessage <span class="title">SetMailFlag</span> (<span class="params">MessageFlags Flage, <span class="keyword">uint</span> uniqueid, <span class="keyword">int</span> accountId, <span class="keyword">string</span> folderName = <span class="literal">null</span></span>)</span> &#123;</span><br><span class="line">    MimeMessage remail;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 查找这个邮件,设置状态</span></span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> client = _receiveEmailService.ImapClientInit (accountId)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (folderName == <span class="literal">null</span>)</span><br><span class="line">                folderName = client.Inbox.Name;</span><br><span class="line">            <span class="keyword">var</span> emailUniqueId = <span class="keyword">new</span> UniqueId (uniqueid);</span><br><span class="line">            <span class="keyword">var</span> folder = client.GetFolder (folderName);</span><br><span class="line">            folder.Open (FolderAccess.ReadWrite);</span><br><span class="line">            remail = folder.GetMessage (emailUniqueId);</span><br><span class="line">            folder.AddFlags (emailUniqueId, Flage, <span class="literal">true</span>);</span><br><span class="line">            folder.Close ();</span><br><span class="line">            client.Disconnect (<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> remail;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 将邮件保存到草稿箱 返回邮件的唯一标识</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">SaveDrafts</span> (<span class="params">MailBoxEntity mailBox, <span class="keyword">int</span> accountId, <span class="keyword">int</span> uniqueId = <span class="number">-1</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        MimeMessage mimeMessage = _mailMessageService.AssemblyMailMessage (mailBox);</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> client = _receiveEmailService.ImapClientInit (accountId)) &#123;</span><br><span class="line">            IMailFolder folder = client.GetFolder (SpecialFolder.Drafts);</span><br><span class="line">            folder.Open (FolderAccess.ReadWrite);</span><br><span class="line">            <span class="comment">// 如果保存的是已经有的草稿邮件,则删除它再保存新的草稿.(没找到保存已有草稿的办法)</span></span><br><span class="line">            <span class="keyword">if</span> (uniqueId &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">                List&lt;UniqueId&gt; uidls = <span class="keyword">new</span> List&lt;UniqueId&gt; &#123;</span><br><span class="line">                    <span class="keyword">new</span> UniqueId ((<span class="keyword">uint</span>) uniqueId)</span><br><span class="line">                &#125;;</span><br><span class="line">                folder.SetFlags (uidls, MessageFlags.Seen | MessageFlags.Deleted, <span class="literal">true</span>);</span><br><span class="line">                folder.Expunge (uidls);</span><br><span class="line">            &#125;</span><br><span class="line">            UniqueId? uid = folder.Append (mimeMessage, MessageFlags.Seen | MessageFlags.Draft);</span><br><span class="line">            folder.Close ();</span><br><span class="line">            client.Disconnect (<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> uid.HasValue ? (<span class="keyword">int</span>) uid.Value.Id : <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 设置邮件已读</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">SetSeen</span> (<span class="params"><span class="keyword">uint</span> uniqueid, <span class="keyword">int</span> accountId, <span class="keyword">string</span> folderName = <span class="literal">null</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">bool</span> r = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SetMailFlag (MessageFlags.Seen, uniqueid, accountId, folderName);</span><br><span class="line">        <span class="comment">// 将本地邮件状态设置为已读</span></span><br><span class="line">        <span class="keyword">var</span> mailBox = _mailBoxService.Get (a =&gt; a.UniqueId == uniqueid &amp;&amp; a.OwnerMailAccount == accountId).ToArray ();</span><br><span class="line">        mailBox.Each (a =&gt; a.IsRead = <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (_mailBoxService.UpdateRange (mailBox) &gt; <span class="number">0</span>) r = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 设置此邮件是对指定邮件的回复</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetReplyTo</span> (<span class="params"><span class="keyword">uint</span> uniqueid, MimeMessage message, <span class="keyword">int</span> AccountId, <span class="keyword">string</span> folderName = <span class="literal">null</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        MimeMessage remail = SetMailFlag (MessageFlags.Answered, uniqueid, AccountId, folderName);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty (remail.MessageId))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// 设置此邮件是对这个MESSAGEID的邮件的回复</span></span><br><span class="line">        message.InReplyTo = remail.MessageId;</span><br><span class="line">        <span class="comment">// 此邮件的"对其它消息"的引用属性设为这个邮件的引用属性</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> id <span class="keyword">in</span> remail.References)</span><br><span class="line">            message.References.Add (id);</span><br><span class="line">        message.References.Add (remail.MessageId);</span><br><span class="line">        MailBoxEntity mail = _mailBoxService.Get (a =&gt; a.UniqueId == uniqueid).FirstOrDefault ();</span><br><span class="line">        mail.IsAnswered = <span class="literal">true</span>;</span><br><span class="line">        _mailBoxService.Update (mail, <span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 设置邮件已删除</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">SetDelted</span> (<span class="params"><span class="keyword">uint</span> uniqueid, <span class="keyword">int</span> accountId, <span class="keyword">string</span> folderName = <span class="literal">null</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">bool</span> r = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SetMailFlag (MessageFlags.Deleted, uniqueid, accountId, folderName);</span><br><span class="line">        <span class="comment">// 将本地邮件状态设置为已删除</span></span><br><span class="line">        MailBoxEntity mailBox = _mailBoxService.Get (a =&gt; a.UniqueId == uniqueid &amp;&amp; a.OwnerMailAccount == accountId).FirstOrDefault ();</span><br><span class="line">        mailBox.DataStatus = (<span class="keyword">int</span>) DataStatus.Deleted;</span><br><span class="line">        <span class="keyword">if</span> (_mailBoxService.Update (mailBox) &gt; <span class="number">0</span>) r = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="组件使用感悟"><a href="#组件使用感悟" class="headerlink" title="组件使用感悟"></a>组件使用感悟</h2><p>MailKit和MimeKit组件在项目的使用中较为的便捷，基本包含了所有的基础邮件服务操作。组件提供的SmtpClient类提供的功能很丰富，例如连接邮件服务器，邮件账户认证，组装邮件消息，获取邮件服务器配置信息等等方法的提供，可以让我们在项目中快速的获取邮件服务的所有信息。</p>
<p>使用过邮件功能的项目 都会有困扰，客户端与邮件服务器的连接是否成功，以及邮件是否发送成功状态没有办法很快的获取，只能根据邮件服务器返回的一场状态进行判断。但是MailKit提供对应的方法和异常类，对邮件服务器返回的异常信息进行解析，客户端可以根据这些异常类获取邮件状态。</p>
<p>MailKit组件的提供了ProtocolLogger类，该类用于记录SMTP操作基础信息，该类作用为记录邮件服务日志。在邮件发送完毕后，需要及时的关闭连接，调用Disconnect(true)方法。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CSharp/" rel="tag">#CSharp</a>
          
            <a href="/tags/Net-Core/" rel="tag">#.Net Core</a>
          
            <a href="/tags/Email/" rel="tag">#Email</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/201811041748/" rel="next" title="Entity Framework Core 之数据库迁移">
                <i class="fa fa-chevron-left"></i> Entity Framework Core 之数据库迁移
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/201812200110/" rel="prev" title="使用Debian时遇到的问题">
                使用Debian时遇到的问题 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/uploads/avatar.jpg" alt="Vick">
          <p class="site-author-name" itemprop="name">Vick</p>
          <p class="site-description motion-element" itemprop="description">只要路是对的，就不怕路远</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">46</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">47</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/VickChen1992" target="_blank" title="github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://gitee.com/vickchen" target="_blank" title="gitee">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  gitee
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#MailKit和MimeKit基础概述"><span class="nav-number">1.</span> <span class="nav-text">MailKit和MimeKit基础概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建基础邮件服务"><span class="nav-number">2.</span> <span class="nav-text">创建基础邮件服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基础实体类"><span class="nav-number">2.1.</span> <span class="nav-text">基础实体类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#邮件实体类"><span class="nav-number">2.1.1.</span> <span class="nav-text">邮件实体类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#邮箱发送服务器配置"><span class="nav-number">2.1.2.</span> <span class="nav-text">邮箱发送服务器配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#邮件发送结果信息"><span class="nav-number">2.1.3.</span> <span class="nav-text">邮件发送结果信息</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#邮件操作服务"><span class="nav-number">2.2.</span> <span class="nav-text">邮件操作服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置基础信息"><span class="nav-number">2.2.1.</span> <span class="nav-text">配置基础信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#发送邮件"><span class="nav-number">2.2.2.</span> <span class="nav-text">发送邮件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#收取邮件"><span class="nav-number">2.2.3.</span> <span class="nav-text">收取邮件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他操作"><span class="nav-number">2.2.4.</span> <span class="nav-text">其他操作</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#组件使用感悟"><span class="nav-number">3.</span> <span class="nav-text">组件使用感悟</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Vick</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
