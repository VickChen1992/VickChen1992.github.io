<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="CSharp,.Net Core,Email," />





  <link rel="alternate" href="/atom.xml" title="Vick's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/icon.ico?v=5.0.1" />






<meta name="description" content="邮件服务是一般的系统都会拥有和需要的功能，但是对于.Net项目来说，邮件服务的创建和使用会较为的麻烦。.NET对于邮件功能提供了System.Net.Mail用于创建邮件服务，该基础服务提供邮件的基础操作，并且使用也较为的简单。对于真正将该功能使用于项目的人，就会慢慢发现其中的优缺点，甚至有些时候不能忍受其中的问题。在这里介绍一种微软用于替代System.Net.Mail的邮件服务组件MailKi">
<meta property="og:type" content="article">
<meta property="og:title" content=".Net Core使用mailket收取和发送邮件">
<meta property="og:url" content="VickChen.win/2018/use-mailket-to-receive-and-send-mail/index.html">
<meta property="og:site_name" content="Vick's Blog">
<meta property="og:description" content="邮件服务是一般的系统都会拥有和需要的功能，但是对于.Net项目来说，邮件服务的创建和使用会较为的麻烦。.NET对于邮件功能提供了System.Net.Mail用于创建邮件服务，该基础服务提供邮件的基础操作，并且使用也较为的简单。对于真正将该功能使用于项目的人，就会慢慢发现其中的优缺点，甚至有些时候不能忍受其中的问题。在这里介绍一种微软用于替代System.Net.Mail的邮件服务组件MailKi">
<meta property="og:updated_time" content="2018-12-14T11:18:10.927Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content=".Net Core使用mailket收取和发送邮件">
<meta name="twitter:description" content="邮件服务是一般的系统都会拥有和需要的功能，但是对于.Net项目来说，邮件服务的创建和使用会较为的麻烦。.NET对于邮件功能提供了System.Net.Mail用于创建邮件服务，该基础服务提供邮件的基础操作，并且使用也较为的简单。对于真正将该功能使用于项目的人，就会慢慢发现其中的优缺点，甚至有些时候不能忍受其中的问题。在这里介绍一种微软用于替代System.Net.Mail的邮件服务组件MailKi">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="VickChen.win/2018/use-mailket-to-receive-and-send-mail/"/>

  <title> .Net Core使用mailket收取和发送邮件 | Vick's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Vick's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                .Net Core使用mailket收取和发送邮件
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-11-23T02:12:00+08:00" content="2018-11-23">
              2018-11-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>邮件服务是一般的系统都会拥有和需要的功能，但是对于.Net项目来说，邮件服务的创建和使用会较为的麻烦。.NET对于邮件功能提供了System.Net.Mail用于创建邮件服务，该基础服务提供邮件的基础操作，并且使用也较为的简单。对于真正将该功能使用于项目的人，就会慢慢发现其中的优缺点，甚至有些时候不能忍受其中的问题。在这里介绍一种微软用于替代System.Net.Mail的邮件服务组件MailKit和MimeKit，官网地址：<a href="http://www.mimekit.net/" target="_blank" rel="external">http://www.mimekit.net/</a> GitHub地址：<a href="https://github.com/jstedfast/MimeKit" target="_blank" rel="external">https://github.com/jstedfast/MimeKit</a></p>
<a id="more"></a>
<h2 id="MailKit和MimeKit基础概述"><a href="#MailKit和MimeKit基础概述" class="headerlink" title="MailKit和MimeKit基础概述"></a>MailKit和MimeKit基础概述</h2><p>MailKit组件是一个免费开源的邮箱类库，简单来说MailKit帮我们封装了有关邮箱的一些帮助类，提供方法让我们更容易使用邮箱的SMTP、POP3、IMAP等协议。该组件是一个跨平台的Email组件，该组件支持.Net Core 、.Net FrameWork、Xamarin.Android、Xamarin.iOS、Windows Phone等等平台。</p>
<p>MimeKit提供了一个MIME解析器，组件具备的解析特性灵活、性能高、很好的处理各种各样的破碎的MIME格式化。MimeKit的性能实际上与GMime相当。</p>
<p>该组件在安全性的还是比较高的，处理安全的方式较多，SASL认证、支持S / MIME v3.2、支持OpenPGP、支持DKIM签名等等方式。Mailkit组件可以通过CancellationToken取消对应的操作，CancellationToken传播应取消操作的通知，一个的CancellationToken使线程，线程池工作项目之间，或取消合作任务的对象。过实例化CancellationTokenSource对象来创建取消令牌，该对象管理从其CancellationTokenSource.Token属性检索的取消令牌。然后，将取消令牌传递到应该收到取消通知的任意数量的线程，任务或操作。令牌不能用于启动取消。<br> MailKit组件支持异步操作，在内部编写的有关I/O异步操作的类</p>
<h2 id="创建基础邮件服务"><a href="#创建基础邮件服务" class="headerlink" title="创建基础邮件服务"></a>创建基础邮件服务</h2><p>介绍过MailKit和MimeKit组建的基础信息，接下来就介绍一下如何使用两个组件的基本功能，在这里我将基本操作做了一个简单的封装，一般的项目可以直接引用封装好的类，大家可以根据实际的情况对该组件进行扩展。</p>
<h3 id="基础实体类"><a href="#基础实体类" class="headerlink" title="基础实体类"></a>基础实体类</h3><h4 id="邮件实体类"><a href="#邮件实体类" class="headerlink" title="邮件实体类"></a>邮件实体类</h4><p>用于保存邮件至数据库</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MailBoxEntity</span> : <span class="title">BaseEntity</span> &#123;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 该邮件所属邮箱账号</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> OwnerMailAccount &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 邮件主题</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Subject &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 邮件文本内容</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> MailTextBody &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 邮件html内容</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> MailHtmlBody &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 邮件内容类型</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> MailBodyType &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">"html"</span>;</div><div class="line"></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 邮件附件文件路径</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> MailFilePath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 收件人地址</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Recipients &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 收件人名字</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> RecipientsName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 抄送</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Cc &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 密送</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Bcc &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 发件人</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Sender &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 发件人地址</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> SenderAddress &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 邮件类型</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> MailType &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 收件/发件时间</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Date &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 邮件标识</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 是否已读，是否回复，是否删除</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> Flag &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 是否已读</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsRead &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 是否已经回复</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsAnswered &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 邮件唯一标识</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> MessageId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 邮件唯一查询标识</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">uint</span>? UniqueId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 引用邮件唯一标识</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> References &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 邮件所属邮箱服务器的文件夹标识</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> inbox(收件箱),</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> archive(档案箱),</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> drafts(草稿箱),</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> flagged(标记的),</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> junk(垃圾箱),</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> sent(发件箱),</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> trash(回收箱)</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> FolderType &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 文件夹名称</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 一般用于区别Inbox文件夹下用户自定义的文件夹</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> FolderName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 附件个数</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>? AttaCount &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line"></div><div class="line">    [NotMapped]</div><div class="line">    <span class="keyword">public</span> List&lt;MailBoxEntity&gt; MailBoxList &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="邮箱发送服务器配置"><a href="#邮箱发送服务器配置" class="headerlink" title="邮箱发送服务器配置"></a>邮箱发送服务器配置</h4><p>此表用于保存邮箱的账号信息及不同邮箱服务器的SMTP端口等信息</p>
<p>当然，这些信息可以拆分成两个表存储。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MailConfigEntity</span> : <span class="title">BaseEntity</span> &#123;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 邮箱显示名</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> DisplayName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 发件SMTP服务器地址</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> SmtpHost &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 收件Imtp服务器地址</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> ImapHost &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">""</span>;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 发件SMTP服务器端口</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>? SmtpPort &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 收件Imtp服务器端口</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span>? ImapPort &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 是否启用SSL</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> IsSsl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="literal">true</span>;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 邮件编码</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> MailEncoding &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">"UTF-8"</span>;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 邮箱账号</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Account &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 邮箱密码/授权码</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 平台ID</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> PlatId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 更新到的日期</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> UpdateTo &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 总发件数量</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> SentCount &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="number">0</span>;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 员工自定义的文件夹列表</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    [NotMapped]</div><div class="line">    <span class="keyword">public</span> List&lt;MailFolderEntity&gt; MailFolders &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="邮件发送结果信息"><a href="#邮件发送结果信息" class="headerlink" title="邮件发送结果信息"></a>邮件发送结果信息</h4><p>用于保存每一封邮件的发送状态，后续也可以关联其它业务表，与自动发送邮件任务配合，记录更多相关信息</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SendResultEntity</span> : <span class="title">BaseEntity</span> &#123;</div><div class="line">    <span class="comment">// [MaxLength (50)]</span></div><div class="line">    <span class="comment">// public string OrderId &#123; get; set; &#125;</span></div><div class="line">    <span class="comment">// [MaxLength (50)]</span></div><div class="line">    <span class="comment">// public string ReviewId &#123; get; set; &#125;</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> MailId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 结果信息</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">string</span> ResultInformation &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="string">"发送成功！"</span>;</div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line">    <span class="comment"><span class="doctag">///</span> 结果状态</span></div><div class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> ResultStatus &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="邮件操作服务"><a href="#邮件操作服务" class="headerlink" title="邮件操作服务"></a>邮件操作服务</h3><h4 id="配置基础信息"><a href="#配置基础信息" class="headerlink" title="配置基础信息"></a>配置基础信息</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 账户认证</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Authenticate</span> (<span class="params">MailConfigEntity mailConfigEntity, SmtpClient client, SendResultEntity sendResultEntity</span>) </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        client.Authenticate (mailConfigEntity.Account, mailConfigEntity.Password);</div><div class="line">    &#125; <span class="keyword">catch</span> (AuthenticationException ex) &#123;</div><div class="line">        sendResultEntity.ResultInformation = <span class="string">$"无效的用户名或密码:<span class="subst">&#123;<span class="number">0</span>&#125;</span>"</span> + ex.Message;</div><div class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (SmtpCommandException ex) &#123;</div><div class="line">        sendResultEntity.ResultInformation = <span class="string">$"尝试验证错误:<span class="subst">&#123;<span class="number">0</span>&#125;</span>"</span> + ex.Message;</div><div class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (SmtpProtocolException ex) &#123;</div><div class="line">        sendResultEntity.ResultInformation = <span class="string">$"尝试验证时的协议错误:<span class="subst">&#123;<span class="number">0</span>&#125;</span>"</span> + ex.Message;</div><div class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">        sendResultEntity.ResultInformation = <span class="string">$"账户认证错误:<span class="subst">&#123;<span class="number">0</span>&#125;</span>"</span> + ex.Message;</div><div class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 获取SMTP基础信息</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">private</span> MailServerInformationEntity <span class="title">SmtpClientBaseMessage</span> (<span class="params">SmtpClient client</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> mailServerInformation = <span class="keyword">new</span> MailServerInformationEntity &#123;</div><div class="line">        Authentication = client.Capabilities.HasFlag (SmtpCapabilities.Authentication),</div><div class="line">        BinaryMime = client.Capabilities.HasFlag (SmtpCapabilities.BinaryMime),</div><div class="line">        Dsn = client.Capabilities.HasFlag (SmtpCapabilities.Dsn),</div><div class="line">        EightBitMime = client.Capabilities.HasFlag (SmtpCapabilities.EightBitMime),</div><div class="line">        Size = client.MaxSize</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">return</span> mailServerInformation;</div><div class="line">&#125;</div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 连接服务器</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Connection</span> (<span class="params">MailConfigEntity sendServerConfiguration, SmtpClient client, SendResultEntity sendResultEntity</span>) </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        client.Connect (sendServerConfiguration.SmtpHost, sendServerConfiguration.SmtpPort.Value);</div><div class="line">    &#125; <span class="keyword">catch</span> (SmtpCommandException ex) &#123;</div><div class="line">        sendResultEntity.ResultInformation = <span class="string">$"尝试连接时出错:<span class="subst">&#123;<span class="number">0</span>&#125;</span>"</span> + ex.Message;</div><div class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (SmtpProtocolException ex) &#123;</div><div class="line">        sendResultEntity.ResultInformation = <span class="string">$"尝试连接时的协议错误:<span class="subst">&#123;<span class="number">0</span>&#125;</span>"</span> + ex.Message;</div><div class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">        sendResultEntity.ResultInformation = <span class="string">$"服务器连接错误:<span class="subst">&#123;<span class="number">0</span>&#125;</span>"</span> + ex.Message;</div><div class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"> <span class="comment"><span class="doctag">///</span> 设置发件人信息</span></div><div class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"> <span class="function"><span class="keyword">private</span> SmtpClient <span class="title">SmtpClientInit</span> (<span class="params"><span class="keyword">int</span> accountId</span>) </span>&#123;</div><div class="line">     <span class="keyword">var</span> m = _mailConfigService.GetAsNoTracking ();</div><div class="line">     MailConfigEntity mailConfig = m.FirstOrDefault (a =&gt; a.FID == accountId);</div><div class="line">     SmtpClient client = <span class="keyword">new</span> SmtpClient () &#123;</div><div class="line">         ServerCertificateValidationCallback = (s, c, h, e) =&gt; <span class="literal">true</span></div><div class="line">     &#125;;</div><div class="line">     <span class="keyword">var</span> sendResultEntity = <span class="keyword">new</span> SendResultEntity ();</div><div class="line">     Connection (mailConfig, client, sendResultEntity);</div><div class="line">     <span class="keyword">if</span> (sendResultEntity.ResultStatus == <span class="literal">false</span>)</div><div class="line">         <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">     SmtpClientBaseMessage (client);</div><div class="line">     Authenticate (mailConfig, client, sendResultEntity);</div><div class="line">     <span class="keyword">return</span> sendResultEntity.ResultStatus == <span class="literal">false</span> ? <span class="literal">null</span> : client;</div><div class="line"> &#125;</div><div class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"> <span class="comment"><span class="doctag">///</span> 设置收件人信息</span></div><div class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">public</span> ImapClient <span class="title">ImapClientInit</span> (<span class="params"><span class="keyword">int</span> AccountId</span>) </span>&#123;</div><div class="line">    MailConfigEntity mailConfig = _mailConfigService.GetAsNoTracking ().FirstOrDefault (a =&gt; a.FID == AccountId);</div><div class="line">    ImapClient client = <span class="keyword">new</span> ImapClient ();</div><div class="line">    client.Connect (mailConfig.ImapHost, mailConfig.ImapPort.Value,</div><div class="line">        SecureSocketOptions.SslOnConnect);</div><div class="line">    client.Authenticate (mailConfig.Account, mailConfig.Password);</div><div class="line">    <span class="meta">#<span class="meta-keyword">region</span> 网易邮箱需要此语句，用于验证客户端身份</span></div><div class="line">    <span class="keyword">if</span> (mailConfig.ImapHost == <span class="string">"imap.126.com"</span> || mailConfig.ImapHost == <span class="string">"imap.163.com"</span>) &#123;</div><div class="line">        <span class="keyword">var</span> clientImplementation = <span class="keyword">new</span> ImapImplementation &#123;</div><div class="line">        Name = <span class="string">"MeSince"</span>,</div><div class="line">        Version = <span class="string">"2.0"</span></div><div class="line">        &#125;;</div><div class="line">        client.Identify (clientImplementation);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></div><div class="line">    <span class="keyword">return</span> client;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="发送邮件"><a href="#发送邮件" class="headerlink" title="发送邮件"></a>发送邮件</h4><p><em>Mailkit使用时会遇到“附件文件名不能为中文”和“附件文件名长度不能超过41字符”的Bug，这里我顺便参照网上的解决了</em></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div></pre></td><td class="code"><pre><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 组装邮件文本/附件邮件信息</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">public</span> MimeMessage <span class="title">AssemblyMailMessage</span> (<span class="params">MailBoxEntity mailBoxEntity</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mailBoxEntity == <span class="literal">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException (<span class="keyword">nameof</span> (mailBoxEntity));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> message = <span class="keyword">new</span> MimeMessage ();</div><div class="line">    <span class="comment">//设置邮件基本信息</span></div><div class="line">    SetMailBaseMessage (message, mailBoxEntity);</div><div class="line">    <span class="keyword">var</span> multipart = <span class="keyword">new</span> Multipart (<span class="string">"mixed"</span>);</div><div class="line">    <span class="comment">//插入文本消息</span></div><div class="line">    <span class="keyword">if</span> (mailBoxEntity.MailHtmlBody.IsNotNullAndWhiteSpace ()) &#123;</div><div class="line">        multipart.Add (<span class="keyword">new</span> MultipartAlternative &#123;</div><div class="line">            AssemblyMailTextMessage (mailBoxEntity.MailHtmlBody, mailBoxEntity.MailBodyType)</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//插入附件信息</span></div><div class="line">    <span class="keyword">if</span> (mailBoxEntity.MailFilePath.IsNotNullAndWhiteSpace ()) &#123;</div><div class="line">        List&lt;FileStream&gt; list = <span class="keyword">new</span> List&lt;FileStream&gt; ();</div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> path <span class="keyword">in</span> mailBoxEntity.MailFilePath.Split (<span class="string">'|'</span>)) &#123;</div><div class="line">            <span class="keyword">if</span> (!File.Exists (path))</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException (<span class="string">"文件未找到"</span>, path);</div><div class="line">            <span class="keyword">string</span>[] contentTypeArr = MimeTypes.GetMimeType (path).Split (<span class="string">'/'</span>);</div><div class="line">            FileStream file = File.Open (path, FileMode.Open);</div><div class="line">            list.Add (file);</div><div class="line">            ContentType contentType = <span class="keyword">new</span> ContentType (contentTypeArr[<span class="number">0</span>], contentTypeArr[<span class="number">1</span>]);</div><div class="line">            MimePart mimePart = <span class="keyword">new</span> MimePart (contentType) &#123;</div><div class="line">                Content = <span class="keyword">new</span> MimeContent (file),</div><div class="line">                ContentDisposition = <span class="keyword">new</span> ContentDisposition (ContentDisposition.Attachment),</div><div class="line">                ContentTransferEncoding = ContentEncoding.Base64,</div><div class="line">            &#125;;</div><div class="line">            <span class="comment">//解决文件名不能为中文</span></div><div class="line">            mimePart.ContentType.Parameters.Add (<span class="string">"GB18030"</span>, <span class="string">"name"</span>, Path.GetFileName (path));</div><div class="line">            mimePart.ContentDisposition.Parameters.Add (<span class="string">"GB18030"</span>, <span class="string">"filename"</span>, Path.GetFileName (path));</div><div class="line">            <span class="comment">//解决文件名长度限制</span></div><div class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> param <span class="keyword">in</span> mimePart.ContentDisposition.Parameters)</div><div class="line">                param.EncodingMethod = ParameterEncodingMethod.Rfc2047;</div><div class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> param <span class="keyword">in</span> mimePart.ContentType.Parameters)</div><div class="line">                param.EncodingMethod = ParameterEncodingMethod.Rfc2047;</div><div class="line">            multipart.Add (mimePart);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//组合邮件内容</span></div><div class="line">    message.Body = multipart;</div><div class="line">    <span class="keyword">return</span> message;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 设置邮件基础信息</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">public</span> MimeMessage <span class="title">SetMailBaseMessage</span> (<span class="params">MimeMessage minMessag, MailBoxEntity mailBoxEntity</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (minMessag == <span class="literal">null</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException ();</div><div class="line">    <span class="keyword">if</span> (mailBoxEntity == <span class="literal">null</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException ();</div><div class="line">    <span class="comment">//插入发件人</span></div><div class="line">    minMessag.From.Add (<span class="keyword">new</span> MailboxAddress (mailBoxEntity.Sender, mailBoxEntity.SenderAddress));</div><div class="line"></div><div class="line">    <span class="comment">//插入收件人</span></div><div class="line">    <span class="keyword">string</span>[] _recipients = mailBoxEntity.Recipients.Split (<span class="string">"|"</span>);</div><div class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> recipients <span class="keyword">in</span> _recipients) &#123;</div><div class="line">        minMessag.To.Add (<span class="keyword">new</span> MailboxAddress (recipients.Trim ()));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mailBoxEntity.Cc.IsNotNullAndWhiteSpace ()) &#123;</div><div class="line">        <span class="comment">//插入抄送人</span></div><div class="line">        <span class="keyword">string</span>[] _cc = mailBoxEntity.Cc.Split (<span class="string">"|"</span>);</div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> cc <span class="keyword">in</span> _cc)</div><div class="line">            minMessag.Cc.Add (<span class="keyword">new</span> MailboxAddress (cc));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mailBoxEntity.Bcc.IsNotNullAndWhiteSpace ()) &#123;</div><div class="line">        <span class="comment">//插入密送人</span></div><div class="line">        <span class="keyword">string</span>[] _bcc = mailBoxEntity.Bcc.Split (<span class="string">"|"</span>);</div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> bcc <span class="keyword">in</span> _bcc)</div><div class="line">            minMessag.Bcc.Add (<span class="keyword">new</span> MailboxAddress (bcc));</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//插入主题</span></div><div class="line">    minMessag.Subject = mailBoxEntity.Subject;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> minMessag;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 组装邮件文本信息</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">public</span> TextPart <span class="title">AssemblyMailTextMessage</span> (<span class="params"><span class="keyword">string</span> mailBody, <span class="keyword">string</span> textPartType</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty (mailBody))</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException ();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty (textPartType))</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException ();</div><div class="line">    <span class="keyword">var</span> textBody = <span class="keyword">new</span> TextPart (textPartType) &#123;</div><div class="line">        Text = mailBody</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">return</span> textBody;</div><div class="line">&#125;</div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 发送邮件</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Send</span> (<span class="params">MailBoxEntity mailBoxEntity, SmtpClient client, SendResultEntity sendResultEntity, <span class="keyword">string</span> replyto, <span class="keyword">int</span> accid</span>) </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        MimeMessage mimeMessage = _mailMessageService.AssemblyMailMessage (mailBoxEntity);</div><div class="line">        <span class="keyword">if</span> (replyto.IsNotNullAndWhiteSpace ()) &#123;</div><div class="line">            <span class="keyword">uint</span>.TryParse (replyto.Trim (<span class="string">'|'</span>), <span class="keyword">out</span> <span class="keyword">uint</span> mailuint);</div><div class="line">            SetReplyTo (mailuint, mimeMessage, accid); <span class="comment">//设置回复</span></div><div class="line">        &#125;</div><div class="line">        client.Send (mimeMessage);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mimeMessage.References != <span class="literal">null</span>) &#123;</div><div class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> mimeMessage.References)</div><div class="line">                mailBoxEntity.References = mailBoxEntity.References + <span class="string">"|"</span> + item;</div><div class="line">        &#125;</div><div class="line">        mailBoxEntity.References = mailBoxEntity.References?.Trim (<span class="string">'|'</span>);</div><div class="line">        mailBoxEntity.MessageId = mimeMessage.MessageId;</div><div class="line"></div><div class="line">        sendResultEntity.MailId = mailBoxEntity.MailType == (<span class="keyword">int</span>) MailType.Auto </div><div class="line">        ? _mailBoxService.Add (mailBoxEntity, <span class="literal">true</span>, <span class="literal">true</span>) : _mailBoxService.Add (mailBoxEntity, <span class="literal">true</span>);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">catch</span> (SmtpCommandException ex) &#123;</div><div class="line">        <span class="keyword">switch</span> (ex.ErrorCode) &#123;</div><div class="line">            <span class="keyword">case</span> SmtpErrorCode.RecipientNotAccepted:</div><div class="line">                sendResultEntity.ResultInformation = <span class="string">$"收件人未被接受:<span class="subst">&#123;ex.Message&#125;</span>"</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> SmtpErrorCode.SenderNotAccepted:</div><div class="line">                sendResultEntity.ResultInformation = <span class="string">$"发件人未被接受:<span class="subst">&#123;ex.Message&#125;</span>"</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> SmtpErrorCode.MessageNotAccepted:</div><div class="line">                sendResultEntity.ResultInformation = <span class="string">$"消息未被接受:<span class="subst">&#123;ex.Message&#125;</span>"</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (SmtpProtocolException ex) &#123;</div><div class="line">        sendResultEntity.ResultInformation = <span class="string">$"发送消息时的协议错误:<span class="subst">&#123;ex.Message&#125;</span>"</span>;</div><div class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">        sendResultEntity.ResultInformation = <span class="string">$"邮件发送失败:<span class="subst">&#123;ex.Message&#125;</span>"</span>;</div><div class="line">        sendResultEntity.ResultStatus = <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="收取邮件"><a href="#收取邮件" class="headerlink" title="收取邮件"></a>收取邮件</h4><p>这部分比较繁琐，先贴代码，然后再解释</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div></pre></td><td class="code"><pre><div class="line">/// &lt;summary&gt;</div><div class="line">/// 接收所有文件夹的邮件</div><div class="line">/// &lt;/summary&gt; </div><div class="line">public bool GetFolders (string Account) &#123;</div><div class="line">    try &#123;</div><div class="line">        bool result = false;</div><div class="line">        MailConfigEntity mailConfig = _mailConfigService.Get ().FirstOrDefault (a =&gt; a.Account == Account);</div><div class="line"></div><div class="line">        List&lt;DateTime&gt; dateTimes = new List&lt;DateTime&gt; &#123;</div><div class="line">            Convert.ToDateTime (mailConfig.UpdateTo)</div><div class="line">        &#125;;</div><div class="line">        // 用户所拥有的文件夹</div><div class="line">        var mailFolderUserEntitys = _mailFolderUserService.GetAsNoTracking ().</div><div class="line">        Where (a =&gt; a.AccountUserID == _applicationContext.CurrentUser.FID &amp;&amp; a.DataStatus == (int) DataStatus.Active)</div><div class="line">            .Select (a =&gt; a.MailFolderId).ToArray ();</div><div class="line">        // 文件夹详细信息</div><div class="line">        var mailFolders = _mailFolderService.GetAsNoTracking ().Where (a =&gt; a.MailAccountId == mailConfig.FID &amp;&amp;</div><div class="line">            a.DataStatus == (int) DataStatus.Active &amp;&amp; a.FolderType == 1 &amp;&amp; mailFolderUserEntitys.Contains (a.FID));</div><div class="line"></div><div class="line">        var mailFoldersArr = mailFolders.Where (a =&gt; mailFolders.Any (r =&gt; r.ParentFolderId == a.FID) == false).Select (a =&gt; a.FID).ToArray ();</div><div class="line"></div><div class="line">        // 文件夹规则表</div><div class="line">        var mailFolderRuleEntities = _mailFolderRuleService.GetAsNoTracking ().Where (a =&gt; mailFoldersArr.Contains (a.FolderId) &amp;&amp;</div><div class="line">            a.DataStatus == (int) DataStatus.Active &amp;&amp; a.RuleContent.IsNotNullAndWhiteSpace ()).ToList ();</div><div class="line"></div><div class="line">        using (var client = ImapClientInit (mailConfig.FID)) &#123;</div><div class="line">            List&lt;IMailFolder&gt; mailFolderList = client.GetFolders (client.PersonalNamespaces[0]).ToList ();</div><div class="line">            foreach (var item in mailFolderList) &#123;</div><div class="line">                item.Open (FolderAccess.ReadOnly);</div><div class="line">                //todo 因未知原因,拉取Junk文件夹邮件拉取时会报错，先跳过</div><div class="line">                if (item.Count &lt; 1 || item.Name.ToLower () == "junk") continue;</div><div class="line">                var m = FillEntity (null, null, item, client, true, mailConfig.FID);</div><div class="line">                if (m.MailBoxList.Count &lt; 1) continue;</div><div class="line">                if (item.Name.ToLower () == "inbox") &#123;</div><div class="line">                    result = true;</div><div class="line">                    // 邮件归档</div><div class="line">                    if (mailFolderRuleEntities.Any ())</div><div class="line">                        MailArchive (m.MailBoxList, mailFolderRuleEntities);</div><div class="line">                &#125;</div><div class="line">                //取出邮件后对比 获得当前文件夹最后一封邮件的时间</div><div class="line">                string maxdate = m.MailBoxList.Max (a =&gt; a.Date);</div><div class="line">                DateTime.TryParse (mailConfig.UpdateTo, out var updateTo);</div><div class="line">                DateTime.TryParse (maxdate, out var date);</div><div class="line">                if (date &gt; updateTo) dateTimes.Add (Convert.ToDateTime (maxdate));</div><div class="line">                //保存所有邮件 </div><div class="line">                _mailBoxService.AddRange (m.MailBoxList);</div><div class="line">            &#125;</div><div class="line">            client.Disconnect (true);</div><div class="line">            // 最后更新时间取所有文件夹最大时间 避免覆盖或取值错误</div><div class="line">            mailConfig.UpdateTo = dateTimes.Max ().ToString ("yyyy-MM-dd HH:mm:ss");</div><div class="line">            //todo 此处排除字段修改无效</div><div class="line">            _mailConfigService.Update (mailConfig, false, "SentCount");</div><div class="line">        &#125;</div><div class="line">        return result;</div><div class="line">    &#125; catch (Exception e) &#123;</div><div class="line">        throw e;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">/// &lt;summary&gt;</div><div class="line">/// 填充实体   </div><div class="line">/// 返回新邮件数量</div><div class="line">/// &lt;/summary&gt;</div><div class="line">private MailBoxEntity FillEntity (IMessageSummary emhead = null, MimeMessage embody = null, IMailFolder folder = null, ImapClient client = null, bool Loop = false, int AccountId = 0) &#123;</div><div class="line">         MailBoxEntity mailbox = new MailBoxEntity ();</div><div class="line">         if (emhead != null) &#123;</div><div class="line">             if (emhead.Envelope.From.Count &gt; 0) &#123;</div><div class="line">                 mailbox.Sender = emhead.Envelope.From.Mailboxes.ElementAt (0).Name;</div><div class="line">                 mailbox.SenderAddress = emhead.Envelope.From.Mailboxes.ElementAt (0).Address;</div><div class="line">             &#125;</div><div class="line">             //记录邮件唯一标识 后续获取邮件全文后可直接修改</div><div class="line">             mailbox.MessageId = emhead.Envelope.MessageId;</div><div class="line">             //记录邮件唯一查询标识 后续根据此字段及文件夹联合查询邮件全文</div><div class="line">             mailbox.UniqueId = emhead.UniqueId.Id;</div><div class="line">             //直接取本地时间 忽略时间差</div><div class="line">             mailbox.Date = emhead.Date.LocalDateTime.ToString ("yyyy-MM-dd HH:mm:ss");</div><div class="line">             //邮件时间=本地时间+时区差</div><div class="line">             //mailbox.Date = emhead.Date.LocalDateTime.</div><div class="line">             //    AddHours(emhead.Date.Offset.TotalHours).ToString("yyyy-MM-dd HH:mm:ss");               </div><div class="line">             mailbox.Subject = emhead.Envelope.Subject;</div><div class="line">             // 有文件夹的则记录邮件头所属文件夹</div><div class="line">             if (folder != null) &#123;</div><div class="line">                 if (folder.Attributes.ToString ().Contains ("Inbox"))</div><div class="line">                     mailbox.FolderType = "Inbox";</div><div class="line">                 else if (folder.Attributes.ToString ().Contains ("Sent"))</div><div class="line">                     mailbox.FolderType = "Sent";</div><div class="line">                 else if (folder.Attributes.ToString ().Contains ("Trash"))</div><div class="line">                     mailbox.FolderType = "Trash";</div><div class="line">                 else if (folder.Attributes.ToString ().Contains ("Drafts"))</div><div class="line">                     mailbox.FolderType = "Drafts";</div><div class="line">                 else</div><div class="line">                     mailbox.FolderType = "Inbox";</div><div class="line">                 mailbox.FolderName = folder.FullName;</div><div class="line">             &#125;</div><div class="line">             // 循环记录收件人</div><div class="line">             foreach (var _Recipients in emhead.Envelope.To.Mailboxes)</div><div class="line">                 mailbox.Recipients = mailbox.Recipients + "|" + _Recipients.Address.Trim ();</div><div class="line">             mailbox.Recipients = mailbox.Recipients?.Trim ('|');</div><div class="line">             //标记为收到的邮件</div><div class="line">             mailbox.MailType = (int) MailType.In;</div><div class="line">             // 邮件状态,已读未读等等</div><div class="line">             if (emhead.Flags.HasValue &amp;&amp; mailbox.FolderType == "Inbox") &#123;</div><div class="line">                 mailbox.IsRead = emhead.Flags.Value.HasFlag (MessageFlags.Seen);</div><div class="line">                 mailbox.IsAnswered = emhead.Flags.Value.HasFlag (MessageFlags.Answered);</div><div class="line">             &#125;</div><div class="line">             // 附件个数</div><div class="line">             mailbox.AttaCount = emhead.Attachments.Count ();</div><div class="line">         &#125;</div><div class="line">         if (embody != null) &#123;</div><div class="line">             mailbox.OwnerMailAccount = AccountId;</div><div class="line">             // 正文</div><div class="line">             mailbox.MailTextBody = embody.TextBody;</div><div class="line">             mailbox.MailHtmlBody = embody.HtmlBody;</div><div class="line">             foreach (var _Cc in embody.Cc) //抄送</div><div class="line">                 mailbox.Cc = embody.Cc + "|" + ((MailboxAddress) _Cc).Address.Trim ();</div><div class="line">             mailbox.Cc = mailbox.Cc?.Trim ('|');</div><div class="line">             foreach (var _Bcc in embody.Bcc) //密送</div><div class="line">                 mailbox.Bcc = embody.Bcc + "|" + ((MailboxAddress) _Bcc).Address.Trim ();</div><div class="line">             mailbox.Bcc = mailbox.Bcc?.Trim ('|');</div><div class="line">             foreach (var _References in embody.References) //引用</div><div class="line">                 mailbox.References = embody.References + "|" + _References;</div><div class="line">             mailbox.References = mailbox.References?.Trim ('|');</div><div class="line">             if (embody.Attachments.Count () &gt; 0) &#123;</div><div class="line">                 // 收件箱箱附件保存路径</div><div class="line">                 string _guid = !string.IsNullOrEmpty (embody.MessageId) ? embody.MessageId : Guid.NewGuid ().ToString ();</div><div class="line">                 string _rootPath = Directory.GetDirectoryRoot (Directory.GetCurrentDirectory ()) + @"RecMailAttachment\" + $" &#123; _guid &#125;</div><div class="line">                 ";</div><div class="line">            if (!Directory.Exists(_rootPath))</div><div class="line">                Directory.CreateDirectory(_rootPath);</div><div class="line">            FileInfo fileInfo;</div><div class="line">            //附件路径集合</div><div class="line">            List&lt;string&gt; _attachPaths = new List&lt;string&gt;();</div><div class="line">            // 这里要转成mimepart类型</div><div class="line">            foreach (MimePart attachment in embody.Attachments)</div><div class="line">            &#123;</div><div class="line">                fileInfo = new FileInfo(Path.Combine(_rootPath, attachment.FileName));</div><div class="line">                _attachPaths.Add(fileInfo.ToString());</div><div class="line">                if (File.Exists(fileInfo.ToString())) continue;</div><div class="line">                using (FileStream fs = new FileStream(fileInfo.ToString(), FileMode.Create))</div><div class="line">                &#123;</div><div class="line">                    attachment.Content.DecodeTo(fs);</div><div class="line">                    fs.Flush();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            mailbox.MailFilePath = _attachPaths.Aggregate((ttl, next) =&gt; string.Format($" &#123; ttl &#125; | &#123; next &#125;"));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //不需要循环或者未指定文件夹的直接返回</div><div class="line">    if (folder == null || !Loop)</div><div class="line">        return mailbox;</div><div class="line">    //需要循环的则循环整个文件夹取值</div><div class="line">    MailConfigEntity mailConfig = _mailConfigService.Get ().FirstOrDefault (a =&gt; a.FID == AccountId);</div><div class="line">    var mails = _mailBoxService.GetAsNoTracking ().Where (a =&gt; a.OwnerMailAccount == mailConfig.FID &amp;&amp; a.MailType == 1).Select (a =&gt; a.UniqueId);</div><div class="line">    mailbox.MailBoxList = new List&lt;MailBoxEntity&gt; ();</div><div class="line">    IList&lt;UniqueId&gt; uids;</div><div class="line">    //如果之前更新过 则仅同步上次同步之后的邮件</div><div class="line">    DateTime Updateto = DateTime.MinValue;</div><div class="line">    if (mailConfig.UpdateTo.IsNotNullAndWhiteSpace ())</div><div class="line">    &#123;</div><div class="line">        DateTime.TryParse (mailConfig.UpdateTo, out Updateto);</div><div class="line">        uids = client.GetFolder (folder.FullName).Search (SearchQuery.DeliveredAfter (Updateto));</div><div class="line">    &#125;</div><div class="line">    else//若是第一次更新 则取出所有邮件</div><div class="line">        uids = client.GetFolder (folder.FullName).Search (SearchQuery.All);</div><div class="line">    if (uids.Count &lt; 1) return mailbox;</div><div class="line">    int pagecount;</div><div class="line">    int sum = uids.Count &gt; 1000 ? 1000 : uids.Count;</div><div class="line">    int pageSize = 100; // 每页记录数</div><div class="line">    if (sum % pageSize == 0)</div><div class="line">        pagecount =sum / pageSize;</div><div class="line">    else</div><div class="line">        pagecount = sum / pageSize + 1;</div><div class="line">    for (int i = 1; i &lt;= pagecount; i++)//分页取最后一千封邮件</div><div class="line">    &#123;</div><div class="line">        var cpage = uids.SkipLast ((i - 1) * pageSize).TakeLast (pageSize).ToList ();</div><div class="line">        var items = folder.Fetch (cpage, MessageSummaryItems.UniqueId | MessageSummaryItems.All);</div><div class="line">        foreach (var item in items)</div><div class="line">        &#123;</div><div class="line">            DateTime.TryParse (item.Date.LocalDateTime.ToString (), out DateTime date);</div><div class="line">            if (date &lt; Updateto || mails.Any (a =&gt; a == item.UniqueId.Id))</div><div class="line">                continue;</div><div class="line">            //取出正文</div><div class="line">            MimeMessage ebody = folder.GetMessage (item.UniqueId);</div><div class="line">            //! 因不同邮箱时间划分混乱以及时区转换等不稳定因素 故此处需重复判断一次时间</div><div class="line">            var mbox = FillEntity (item, ebody, folder, null, false, AccountId);</div><div class="line">            mailbox.MailBoxList.Add (mbox);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return mailbox;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>原本逻辑为初次仅拉取邮件头，用户点击详情后再拉取详情。收件速度可成倍提升</p>
<p>但目前客户需求在列表预览邮件部分内容，所以暂时选择全部拉取，后续可以改为仅拉取加载出邮件头的详情</p>
<h4 id="其他操作"><a href="#其他操作" class="headerlink" title="其他操作"></a>其他操作</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 设置单个邮件状态</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">private</span> MimeMessage <span class="title">SetMailFlag</span> (<span class="params">MessageFlags Flage, <span class="keyword">uint</span> uniqueid, <span class="keyword">int</span> accountId, <span class="keyword">string</span> folderName = <span class="literal">null</span></span>) </span>&#123;</div><div class="line">    MimeMessage remail;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 查找这个邮件,设置状态</span></div><div class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> client = _receiveEmailService.ImapClientInit (accountId)) &#123;</div><div class="line">            <span class="keyword">if</span> (folderName == <span class="literal">null</span>)</div><div class="line">                folderName = client.Inbox.Name;</div><div class="line">            <span class="keyword">var</span> emailUniqueId = <span class="keyword">new</span> UniqueId (uniqueid);</div><div class="line">            <span class="keyword">var</span> folder = client.GetFolder (folderName);</div><div class="line">            folder.Open (FolderAccess.ReadWrite);</div><div class="line">            remail = folder.GetMessage (emailUniqueId);</div><div class="line">            folder.AddFlags (emailUniqueId, Flage, <span class="literal">true</span>);</div><div class="line">            folder.Close ();</div><div class="line">            client.Disconnect (<span class="literal">true</span>);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> remail;</div><div class="line">&#125;</div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 将邮件保存到草稿箱 返回邮件的唯一标识</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">SaveDrafts</span> (<span class="params">MailBoxEntity mailBox, <span class="keyword">int</span> accountId, <span class="keyword">int</span> uniqueId = <span class="number">-1</span></span>) </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        MimeMessage mimeMessage = _mailMessageService.AssemblyMailMessage (mailBox);</div><div class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> client = _receiveEmailService.ImapClientInit (accountId)) &#123;</div><div class="line">            IMailFolder folder = client.GetFolder (SpecialFolder.Drafts);</div><div class="line">            folder.Open (FolderAccess.ReadWrite);</div><div class="line">            <span class="comment">// 如果保存的是已经有的草稿邮件,则删除它再保存新的草稿.(没找到保存已有草稿的办法)</span></div><div class="line">            <span class="keyword">if</span> (uniqueId &gt; <span class="number">-1</span>) &#123;</div><div class="line">                List&lt;UniqueId&gt; uidls = <span class="keyword">new</span> List&lt;UniqueId&gt; &#123;</div><div class="line">                    <span class="keyword">new</span> UniqueId ((<span class="keyword">uint</span>) uniqueId)</div><div class="line">                &#125;;</div><div class="line">                folder.SetFlags (uidls, MessageFlags.Seen | MessageFlags.Deleted, <span class="literal">true</span>);</div><div class="line">                folder.Expunge (uidls);</div><div class="line">            &#125;</div><div class="line">            UniqueId? uid = folder.Append (mimeMessage, MessageFlags.Seen | MessageFlags.Draft);</div><div class="line">            folder.Close ();</div><div class="line">            client.Disconnect (<span class="literal">true</span>);</div><div class="line">            <span class="keyword">return</span> uid.HasValue ? (<span class="keyword">int</span>) uid.Value.Id : <span class="number">-1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 设置邮件已读</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">SetSeen</span> (<span class="params"><span class="keyword">uint</span> uniqueid, <span class="keyword">int</span> accountId, <span class="keyword">string</span> folderName = <span class="literal">null</span></span>) </span>&#123;</div><div class="line">    <span class="keyword">bool</span> r = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        SetMailFlag (MessageFlags.Seen, uniqueid, accountId, folderName);</div><div class="line">        <span class="comment">// 将本地邮件状态设置为已读</span></div><div class="line">        <span class="keyword">var</span> mailBox = _mailBoxService.Get (a =&gt; a.UniqueId == uniqueid &amp;&amp; a.OwnerMailAccount == accountId).ToArray ();</div><div class="line">        mailBox.Each (a =&gt; a.IsRead = <span class="literal">true</span>);</div><div class="line">        <span class="keyword">if</span> (_mailBoxService.UpdateRange (mailBox) &gt; <span class="number">0</span>) r = <span class="literal">true</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> r;</div><div class="line">&#125;</div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 设置此邮件是对指定邮件的回复</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetReplyTo</span> (<span class="params"><span class="keyword">uint</span> uniqueid, MimeMessage message, <span class="keyword">int</span> AccountId, <span class="keyword">string</span> folderName = <span class="literal">null</span></span>) </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        MimeMessage remail = SetMailFlag (MessageFlags.Answered, uniqueid, AccountId, folderName);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty (remail.MessageId))</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        <span class="comment">// 设置此邮件是对这个MESSAGEID的邮件的回复</span></div><div class="line">        message.InReplyTo = remail.MessageId;</div><div class="line">        <span class="comment">// 此邮件的"对其它消息"的引用属性设为这个邮件的引用属性</span></div><div class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> id <span class="keyword">in</span> remail.References)</div><div class="line">            message.References.Add (id);</div><div class="line">        message.References.Add (remail.MessageId);</div><div class="line">        MailBoxEntity mail = _mailBoxService.Get (a =&gt; a.UniqueId == uniqueid).FirstOrDefault ();</div><div class="line">        mail.IsAnswered = <span class="literal">true</span>;</div><div class="line">        _mailBoxService.Update (mail, <span class="literal">true</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></div><div class="line"><span class="comment"><span class="doctag">///</span> 设置邮件已删除</span></div><div class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">SetDelted</span> (<span class="params"><span class="keyword">uint</span> uniqueid, <span class="keyword">int</span> accountId, <span class="keyword">string</span> folderName = <span class="literal">null</span></span>) </span>&#123;</div><div class="line">    <span class="keyword">bool</span> r = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        SetMailFlag (MessageFlags.Deleted, uniqueid, accountId, folderName);</div><div class="line">        <span class="comment">// 将本地邮件状态设置为已删除</span></div><div class="line">        MailBoxEntity mailBox = _mailBoxService.Get (a =&gt; a.UniqueId == uniqueid &amp;&amp; a.OwnerMailAccount == accountId).FirstOrDefault ();</div><div class="line">        mailBox.DataStatus = (<span class="keyword">int</span>) DataStatus.Deleted;</div><div class="line">        <span class="keyword">if</span> (_mailBoxService.Update (mailBox) &gt; <span class="number">0</span>) r = <span class="literal">true</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> r;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="组件使用感悟"><a href="#组件使用感悟" class="headerlink" title="组件使用感悟"></a>组件使用感悟</h2><p>MailKit和MimeKit组件在项目的使用中较为的便捷，基本包含了所有的基础邮件服务操作。组件提供的SmtpClient类提供的功能很丰富，例如连接邮件服务器，邮件账户认证，组装邮件消息，获取邮件服务器配置信息等等方法的提供，可以让我们在项目中快速的获取邮件服务的所有信息。</p>
<p>使用过邮件功能的项目 都会有困扰，客户端与邮件服务器的连接是否成功，以及邮件是否发送成功状态没有办法很快的获取，只能根据邮件服务器返回的一场状态进行判断。但是MailKit提供对应的方法和异常类，对邮件服务器返回的异常信息进行解析，客户端可以根据这些异常类获取邮件状态。</p>
<p>MailKit组件的提供了ProtocolLogger类，该类用于记录SMTP操作基础信息，该类作用为记录邮件服务日志。在邮件发送完毕后，需要及时的关闭连接，调用Disconnect(true)方法。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CSharp/" rel="tag">#CSharp</a>
          
            <a href="/tags/Net-Core/" rel="tag">#.Net Core</a>
          
            <a href="/tags/Email/" rel="tag">#Email</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/database-migration-of-entity-framework-Core/" rel="next" title="Entity Framework Core 之数据库迁移">
                <i class="fa fa-chevron-left"></i> Entity Framework Core 之数据库迁移
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/problems-when-using-Debian/" rel="prev" title="使用Debian时遇到的问题">
                使用Debian时遇到的问题 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="Vick" />
          <p class="site-author-name" itemprop="name">Vick</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">25</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/VickChen1992" target="_blank" title="github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/_VickChen" target="_blank" title="twitter">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/VickChen92" target="_blank" title="facebook">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                  facebook
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#MailKit和MimeKit基础概述"><span class="nav-number">1.</span> <span class="nav-text">MailKit和MimeKit基础概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建基础邮件服务"><span class="nav-number">2.</span> <span class="nav-text">创建基础邮件服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基础实体类"><span class="nav-number">2.1.</span> <span class="nav-text">基础实体类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#邮件实体类"><span class="nav-number">2.1.1.</span> <span class="nav-text">邮件实体类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#邮箱发送服务器配置"><span class="nav-number">2.1.2.</span> <span class="nav-text">邮箱发送服务器配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#邮件发送结果信息"><span class="nav-number">2.1.3.</span> <span class="nav-text">邮件发送结果信息</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#邮件操作服务"><span class="nav-number">2.2.</span> <span class="nav-text">邮件操作服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置基础信息"><span class="nav-number">2.2.1.</span> <span class="nav-text">配置基础信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#发送邮件"><span class="nav-number">2.2.2.</span> <span class="nav-text">发送邮件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#收取邮件"><span class="nav-number">2.2.3.</span> <span class="nav-text">收取邮件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他操作"><span class="nav-number">2.2.4.</span> <span class="nav-text">其他操作</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#组件使用感悟"><span class="nav-number">3.</span> <span class="nav-text">组件使用感悟</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Vick</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
